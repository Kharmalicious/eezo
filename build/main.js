class t{constructor(e=0,s=0,i=0,n=255){this.red=e,this.green=s,this.blue=i,this.alpha=n;const r=t.rgbToHsl(e,s,i);this.hue=r.h,this.saturation=r.s,this.lightness=r.l}get hex(){const t=(256*this.red*256+256*this.green+this.blue).toString(16);return 6===t.length?t:new Array(6-t.length+1).join("0")+t}get string(){return 255===this.alpha?`#${this.hex}`:`rgba(${this.red}, ${this.green}, ${this.blue}, ${this.alpha})`}get array(){return[this.red,this.green,this.blue]}get object(){return{red:this.red,green:this.green,blue:this.blue}}get percentage(){return t.mult(this,1/255)}get rgb(){return{r:this.red,g:this.green,b:this.blue}}lighten(e,s){const i=s?t.get(s):t.get(255,255,255),n=t.get(t.mult(this,i.percentage));return n.lightness=Math.min(n.lightness+e,1),t.get(t.hslToRgb(n.hue,n.saturation,n.lightness),this.a)}static rgbToHsl(e,s,i){const n=t.percentage({red:e,green:s,blue:i}),r=Math.max(n.red,n.green,n.blue),o=Math.min(n.red,n.green,n.blue),h={h:0,s:0,l:(r+o)/2};if(r!==o){const t=r-o;switch(h.s=h.l>.5?t/(2-r-o):t/(r+o),r){case n.red:h.h=(n.green-n.blue)/t+(n.green<n.blue?6:0);break;case n.green:h.h=(n.blue-n.red)/t+2;break;case n.blue:h.h=(n.red-n.green)/t+4}h.h/=6}return h}static hslToRgb(e=0,s=0,i=1){const n={red:i,green:i,blue:i};if(0!==s){const r=i<.5?i*(1+s):i+s-i*s,o=2*i-r;n.red=t.hue2rgb(o,r,e+1/3),n.green=t.hue2rgb(o,r,e),n.blue=t.hue2rgb(o,r,e-1/3)}return[parseInt(255*n.red),parseInt(255*n.green),parseInt(255*n.blue)]}static hue2rgb(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+(e-t)*(2/3-s)*6:t}static mult(t,e){return"number"==typeof e?{red:t.red*e,green:t.green*e,blue:t.blue*e}:{red:t.red*e.red,green:t.green*e.green,blue:t.blue*e.blue}}static percentage(e){return t.mult(e,1/255)}static get(){if("number"!=typeof arguments[0]&&!arguments[0])return null;if(arguments.length>2)return t.fromArray(arguments);{const e=arguments[0]||0,s=arguments[1]||1;if("number"==typeof e)return t.fromHex(e,Math.round(255*s));if(e instanceof Array)return t.fromArray(e);if(e instanceof Object)return t.fromObject(e)}return null}static random(){return new t(parseInt(255*Math.random()),parseInt(255*Math.random()),parseInt(255*Math.random()))}static fromHex(e,s){const i=`000000${e.toString(16)}`.substr(-6),n=/^([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(i);return n?new t(parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16),s):null}static fromArray(e){return new t(e[0]||0,e[1]||0,e[2]||0,e[3]||255)}static fromObject(e){return new t(e.red||0,e.green||0,e.blue||0,e.alpha||255)}}class e{constructor(t=0,e=0,s=0){this.x=parseFloat(t),this.y=parseFloat(e),this.z=parseFloat(s)}toOrtho(){return e.get(this.x-this.y,(this.x+this.y)/2-1.25*this.z)}toIso(){return e.get(this.y+this.x/2,this.y-this.x/2)}get depth(){return-(this.x+this.y+2*this.z)}get average(){return(this.x+this.y+this.z)/3}get array(){return[this.x,this.y,this.z]}get object(){return{x:this.x,y:this.y,z:this.z}}get round(){return e.get(Math.round(100*this.x)/100,Math.round(100*this.y)/100,Math.round(100*this.z)/100)}get abs(){return e.get(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z))}replace({x:t,y:s,z:i}){return e.get(void 0!==t?t:this.x,void 0!==s?s:this.y,void 0!==i?i:this.z)}sum(t=0,s=0,i=0){const{x:n,y:r,z:o}=e.get(t,s,i);return e.get(this.x+n,this.y+r,this.z+o)}mult(t=1,s=t,i=t){const{x:n,y:r,z:o}=e.get(t,s,i);return e.get(this.x*n,this.y*r,this.z*o)}sub(t=0,s=0,i=0){const{x:n,y:r,z:o}=e.get(t,s,i);return this.sum(e.get(n,r,o).mult(-1))}distance(t,s,i){const n=this.sub(e.get(t,s,i));return Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z)}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}rotateX(t,s=[0,0]){return this._rotate(t,e.get(s),"x")}rotateY(t,s=[0,0]){return this._rotate(t,e.get(s),"y")}rotateZ(t,s=[0,0]){return this._rotate(t,e.get(s),"z")}_rotate(t,s,i){const{x:n,y:r,z:o}=this._getRotationCoords(i),h=this[n]-s[n],a=this[r]-s[r],p=t*(Math.PI/180),c=h*Math.cos(p)-a*Math.sin(p),l=h*Math.sin(p)+a*Math.cos(p);return e.get({[n]:c+s[n],[r]:l+s[r],[o]:this[o]})}_getRotationCoords(t){const e="xyz",s=e.indexOf(t),i=e.substr(s)+e.substr(0,s);return{x:i.substr(1,1),y:i.substr(2,1),z:t}}static get(t){return"number"==typeof t?new e(...arguments):t instanceof Array?new e(...t):t instanceof Object?new e(t.x||0,t.y||0,t.z||0):void 0}}class s{constructor(t={}){this.props={scale:[1,1,1],size:[0,0,0],position:[0,0,0],rotation:[0,0,0],alpha:1,...t},this.props.scale=e.get(this.props.scale),this.props.size=e.get(this.props.size),this.props.position=e.get(this.props.position),this.props.rotation=e.get(this.props.rotation),this._parent=null}set parent(t){this._parent=t,this.onAdd(),this.update()}get parent(){return this._parent}get layer(){return this.parent.layer}get depth(){return this.renderPosition.depth}get renderPosition(){return this.parent?.renderPosition.sum(this.props.position)||this.props.position}get renderRotation(){return this.parent?.renderRotation.sum(this.props.rotation)||this.props.rotation}get renderScale(){return this.parent?.renderScale.mult(this.props.scale)||this.props.scale}alpha(t){return this._setProp("alpha",t)}size(){return this._setPoint("size",...arguments)}position(){return this._setPoint("position",...arguments)}rotation(){return this._setPoint("rotation",...arguments)}scale(){return this._setPoint("size",this.props.size.mult(...arguments))}translate(){return this._setPoint("position",this.props.position.sum(...arguments))}rotate(){return this._setPoint("rotation",this.props.rotation.sum(...arguments))}update(){}step(t){this._stepCallback=t}clone(){return new this.constructor(this.props)}onAdd(){}_stepRender(t){"function"==typeof this._stepCallback&&this._stepCallback(t)}_setProp(t,e){return this.props[t]=e,this.update(),this}_setPoint(t,...s){const i=e.get(...s);if(!(this.props[t]instanceof e))throw new Error("FAILURE on _setPoint",this);return this.props[t]=this.props[t].replace(i),this.update(),this}}class i extends s{constructor(e){super(e),this.props={text:"",font:"20px Open Sans",align:"left",baseline:"top",color:0,...this.props},this.props.color=t.get(this.props.color)}text(t){return this._setProp("text",t)}font(t){return this._setProp("font",t)}align(t){return this._setProp("align",t)}baseline(t){return this._setProp("baseline",t)}color(e){return this._setProp("color",t.get(e))}}class n{constructor(t=0,e=0,s=0){this.i=parseFloat(t),this.j=parseFloat(e),this.k=parseFloat(s)}magnitude(){return Math.sqrt(this.i*this.i+this.j*this.j+this.k*this.k)}normalize(){const t=this.magnitude();return 0===t?new n(0,0,0):new n(this.i/t,this.j/t,this.k/t)}static dotProduct(t,e){return t.i*e.i+t.j*e.j+t.k*e.k}static fromTwoPoints(t,s){return new n(...e.get(t.sum(e.get(s).mult(-1))).array)}static crossProduct(t,e){return new n(t.j*e.k-e.j*t.k,-1*(t.i*e.k-e.i*t.k),t.i*e.j-e.i*t.j)}static get(t){return"number"==typeof t?new n(...arguments):t instanceof Array?new n(...t):t instanceof Object?new n(t.i||t.x||0,t.j||t.y||0,t.k||t.z||0):void 0}}class r{constructor({color:e=14606046,position:s=[2,-1,3],colorDifference:i=.2}={}){this.color=t.get(e),this.position=n.get(s),this.colorDifference=i,this.angle=this.position.normalize()}computeColor(t,e){if(e.length<3)return t;const s=n.fromTwoPoints(e[1],e[0]),i=n.fromTwoPoints(e[2],e[1]),r=n.crossProduct(s,i).normalize(),o=n.dotProduct(r,this.angle);return t.lighten(o*this.colorDifference,this.color)}}class o{constructor(t,s,i=[0,0],n=[]){this._size={width:t,height:s},this._grid=n,this._origin=e.get(i);for(let e=0;e<s;e++)for(let e=0;e<t;e++)this._grid.push(0)}clone(){return new this.constructor(this._size.width,this._size.height,this._origin,this._grid)}freeTile(t,e){const s=this._origin.sum(t,e);this._grid[this._size.width*s.y+s.x]=0}setTile(t,e){const s=this._origin.sum(t,e);this._grid[this._size.width*s.y+s.x]=1}getTile(t,e){const s=this._origin.sum(t,e);return this._grid[this._size.width*s.y+s.x]}isFree(t,e){const s=this._origin.sum(t,e);return 0===this._grid[this._size.width*s.y+s.x]}}class h extends s{constructor(t){super(t),this._children=[]}get orderedChildren(){return this._children.sort(((t,e)=>e.depth-t.depth))}add(t){return t instanceof Array?t.forEach((t=>this.add(t))):this._addChild(t),this}remove(t){return t instanceof Array?t.forEach((t=>this.remove(t))):_removeChild(t),this}_addChild(t){if(t instanceof s){const e=this._children.indexOf(t);~e&&this._children.splice(e,1),this._children.push(t),t.parent=this}else console.log("cant add",t)}_removeChild(t){const e=this._children.indexOf(t);e>-1?(this._children.splice(e,1),t.parent=null):console.log("cant remove",t)}}class a{constructor(e=[],s=0,i=0){this.points=e,this.color=t.get(s),this.stroke=t.get(i)}get depth(){let t=0;for(let e of this.points)t+=e.depth;return t/(this.points.length||1)}add(t){return t instanceof Array?this.points=this.points.concat(t):this.points.push(t),this}reverse(){const t=this.points.slice().reverse();return new a(t,this.color,this.stroke)}scale(t=1,s=t,i=t){const n=this.points.map((n=>e.get(t,s,i).mult(n)));return new a(n,this.color,this.stroke)}translate(t=0,s=0,i=0){const n=this.points.map((n=>e.get(t,s,i).sum(n)));return new a(n,this.color,this.stroke)}rotate(t,e){const s=this.points.map((s=>s.rotateX(t.x,e))).map((s=>s.rotateY(t.y,e))).map((s=>s.rotateZ(t.z,e)));return new a(s,this.color,this.stroke)}static extrude(t,e){const{points:s,color:i,stroke:n}=t,r=[],o=t.translate({z:e});for(let t=0;t<s.length;t++)r.push(new a([s[t],s[(t+1)%s.length],o.points[(t+1)%s.length],o.points[t]],i,n));return r.push(o),r.push(t.reverse()),r}static isPointInPath(t,e){const{points:s}=t;for(let t=!1,i=-1,n=s.length,r=n-1;++i<n;r=i)(s[i].y<=e.y&&e.y<s[r].y||s[r].y<=e.y&&e.y<s[i].y)&&e.x<(s[r].x-s[i].x)*(e.y-s[i].y)/(s[r].y-s[i].y)+s[i].x&&(t=!t);return c}static Rect(t=1,s=1,i=0,n=0){return new a([e.get(0,0,0),e.get(t,0,0),e.get(t,s,0),e.get(0,s,0)],i,n)}static Circle(t=1,s=20,i=0,n=0){const r=.5*t,o=e.get(r,r),h=[o.sum(r*Math.cos(0),r*Math.sin(0))];for(let t=1;t<=s;t+=1)h.push(o.sum(r*Math.cos(2*t*Math.PI/s),r*Math.sin(2*t*Math.PI/s)));return new a(h,i,n)}}class p extends s{constructor(e={},s=new a){super(e),this.props={color:null,stroke:null,wireframe:!1,extruded:!1,...this.props},this.props.color=t.get(this.props.color),this.props.stroke=t.get(this.props.stroke||(this.props.wireframe?0:null)),this.path=s,this.extraPaths=[]}get paths(){return(this.extrudePaths.length?this.extrudePaths:[this.path]).concat(this.extraPaths).map((t=>t.rotate(this.props.rotation,this.props.size.mult(.5))))}get orderedPaths(){return this.paths.sort(((t,e)=>e.depth-t.depth))}get extrudePaths(){return this.props.extruded?a.extrude(this.path,this.props.size.z):[]}add(t){return t instanceof Array?this.extraPaths=this.extraPaths.concat(t):this.extraPaths.push(t),this}clearPaths(){this.extraPaths=[]}extrude(t){return this.props.size.z=t,this._setProp("extruded",!0)}stroke(e){return this._setProp("stroke",t.get(e))}color(e){return this._setProp("color",t.get(e))}}class l extends s{constructor(t={}){super(t),this.props={wireframe:!1,imagePath:null,sourceSize:[0,0],sourcePosition:[0,0],destinationSize:null,destinationPosition:[0,0],...this.props},this.props.sourceSize=e.get(this.props.sourceSize),this.props.sourcePosition=e.get(this.props.sourcePosition),this.props.destinationSize=e.get(this.props.destinationSize||this.props.sourceSize),this.props.destinationPosition=e.get(this.props.destinationPosition),this._loaded=!1,this.image=new Image,this.image.onload=t=>{this._loaded||(this.updateImageSize(t.target),this.onLoad(t))},this.props.imagePath&&(this.image.src=this.props.imagePath)}get source(){return{size:this.props.sourceSize,position:this.props.sourcePosition}}get destination(){return{size:this.props.destinationSize,position:this.props.destinationPosition}}updateImageSize(t){this._loaded=!0,0===this.props.sourceSize.average&&(this.props.sourceSize=e.get(t.naturalWidth,t.naturalHeight)),0===this.props.destinationSize.average&&(this.props.destinationSize=this.props.sourceSize)}onLoad(t){}}class d{constructor(){this._times=[],this._showFPS=!1,this._callback=null}start(t){this._showFPS=!0,this._callback=t,this._step()}stop(){this._showFPS=!1}_step(){const t=performance.now();for(;this._times.length&&this._times[0]<=t-1e3;)this._times.shift();this._times.push(t),"function"==typeof this._callback&&this._callback(this._times.length),this._showFPS&&requestAnimationFrame(this._step.bind(this))}}class u extends h{constructor(){super(),this.canvas=document.createElement("canvas"),this.canvas.style.cssText="width: 100%; height: 100%;",this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),this.size={width:window.innerWidth,height:window.innerHeight},this.imageCache={},this.light=new r,this.canvas.addEventListener("click",this._clickHandler.bind(this)),window.addEventListener("resize",this._resizeHandler.bind(this))}get layers(){return this._children}get size(){return{width:this.canvas.width,height:this.canvas.height}}set size({width:t,height:e}){this.canvas.width=2*t||this.canvas.width,this.canvas.height=2*e||this.canvas.height}showFPS(t){this.fpsCounter||(this.fpsCounter=new d),this.fpsCounter.start(t)}hideFPS(){this.fpsCounter?.stop()}preloadImage(t){const e=new Image;e.onload=e=>{this.imageCache[t]=e.target},e.src=t}start(){this._playing=!0,this._startTime=0,requestAnimationFrame(this._step.bind(this))}stop(){this._playing=!1}_step(t){0===this._startTime&&(this._startTime=t),this.render(t-this._startTime),this._playing&&requestAnimationFrame(this._step.bind(this))}_resizeHandler(){this.size={width:window.innerWidth,height:window.innerHeight},this.render()}_clickHandler(t){const s=e.get(t.clientX,t.clientY).mult(2);for(let t of this.layers){const e=s.sub(t.getOrigin(this.size)),i=t.screenToLayer(e),n=t.getTile(i);t.emit("click",{position:i,tile:n})}}render(t){this.context.clearRect(0,0,this.size.width,this.size.height);for(let e of this.layers)this._renderChildren(e.orderedChildren,e,t)}_renderChildren(t,e,s){for(let i of t)i instanceof h?this._renderChildren(i.orderedChildren,e,s):this._renderChild(i,e,s)}_renderChild(t,e,s){t._stepRender(s);const n=e.getOrigin(this.size);if(t instanceof p)for(let s of t.orderedPaths)this._drawPath(s,n,t.renderPosition,e);else t instanceof l?this._drawBitmap(t,n,t.renderPosition,e):t instanceof i&&this._drawLabel(t,n,t.renderPosition,e)}_drawPath(t,e,s,i){const{points:n=[],color:r,stroke:o}=t;if(!n.length)return null;const h=i.layerToScreen(s.sum(n[0])).sum(e);this.context.beginPath(),this.context.moveTo(h.x,h.y);for(let t,r=1,o=n.length;r<o;r++)t=i.layerToScreen(s.sum(n[r])).sum(e),this.context.lineTo(t.x,t.y);this.context.closePath();const a=r?this.light.computeColor(r,n):null;this.context.save(),(o||a)&&(this.context.strokeStyle=o?.string||a?.string),a&&(this.context.fillStyle=a?.string),this.context.lineWidth=0,this.context.globalAlpha=1,this.context.stroke(),this.context.fill(),this.context.restore()}_drawBitmap(t,e,s,i){const{image:n,source:r,destination:o,props:h}=t,{size:a,position:p,wireframe:c}=h,l=i.layerToScreen(s.sum([.5,.5])).sum(e),{x:d,y:u}=r.size,{x:g,y:m}=r.position,{x:_,y:x}=o.size,{x:f,y:y}=o.position.sum(l);this.context.save(),this.context.globalAlpha=1,this.context.drawImage(n,g,m,d,u,f,y,_,x),c&&this.context.strokeRect(f,y,_,x),this.context.restore()}_drawLabel(t,e,s,i){const{position:n,text:r,font:o,baseline:h,color:a}=t.props,p=i.layerToScreen(s.sum(n)).sum(e);this.context.save(),this.context.transform(2,0,0,2,0,0),this.context.font=o,this.context.textBaseline=h,this.context.globalAlpha=1,this.context.fillStyle=a.string,this.context.fillText(r,p.x,p.y),this.context.restore()}}class g extends h{static T=0;static L=0;static B=1;static R=1;static C=.5;static ORIGIN__TOP_LEFT=e.get(g.L,g.T);static ORIGIN__TOP_RIGHT=e.get(g.R,g.T);static ORIGIN__TOP_CENTER=e.get(g.C,g.T);static ORIGIN__BOTTOM_LEFT=e.get(g.L,g.B);static ORIGIN__BOTTOM_RIGHT=e.get(g.R,g.B);static ORIGIN__BOTTOM_CENTER=e.get(g.C,g.B);static ORIGIN__CENTER_LEFT=e.get(g.L,g.C);static ORIGIN__CENTER_RIGHT=e.get(g.R,g.C);static ORIGIN__CENTER=e.get(g.C,g.C);static TYPE__2D="2d";static TYPE__ISO="iso";constructor(t=g.ORIGIN__CENTER,e=g.TYPE__2D,s=1){super(),this.ORIGIN=t,this.TYPE=e,this.UNIT=s,this._listeners={},this._nodes={}}get layer(){return this}get stage(){return this._parent instanceof u?this._parent:null}addGridPath(){this._gridpath=new o(20,20,[10,10])}getTile(t){const s=e.get(t);return s.x<0?s.x=-Math.ceil(-1*s.x):s.x=Math.floor(s.x),s.y<0?s.y=-Math.ceil(-1*s.y):s.y=Math.floor(s.y),s}getOrigin({width:t,height:s}){return e.get(t,s).mult(this.ORIGIN)}screenToLayer(t){const e=t.mult(1/this.UNIT);return this.TYPE===g.TYPE__ISO?e.toIso():e}layerToScreen(t){const e=t.mult(this.UNIT);return this.TYPE===g.TYPE__ISO?e.toOrtho():e}subscribe(t,e){if("function"!=typeof e)throw new Error("event callback is not a function");this._listeners[t]||(this._listeners[t]=[]),this._listeners[t].push(e)}emit(t,e){if(!this._listeners[t])return null;for(let s of this._listeners[t])s(t,e)}origin(t){return this.ORIGIN=t,this}type(t){return this.TYPE=t,this}}class m{constructor(t="div"){this.element=document.createElement(t),this.element.style.cssText="box-sizing: border-box; padding: 4px;"}onChange(){}createSelect(t=[]){const e=document.createElement("select");for(let s in t){const i=document.createElement("option");i.text=t[s],i.value=s,e.appendChild(i)}return e}updateSelect(t,e=[],s=null){for(t.value;t.firstChild;)t.removeChild(t.lastChild);for(let i in e){const n=document.createElement("option"),r=null===s?~~i==e.length-1:~~i===s;n.text=e[i],n.value=i,n.selected=r,t.appendChild(n)}}createButton(t="button"){const e=document.createElement("button");return e.textContent=t,e}createTextField(t="text"){const e=document.createElement("input");return e.setAttribute("type",t),e}createRange(t=0,e=0,s=1){const i=document.createElement("input");return i.setAttribute("type","range"),i.setAttribute("min",t),i.setAttribute("max",e),i.setAttribute("step",s),i}updateRange(t,{min:e,max:s,step:i,value:n}={}){"number"==typeof e&&t.setAttribute("min",e),"number"==typeof s&&t.setAttribute("max",s),"number"==typeof i&&t.setAttribute("step",i),"number"==typeof n&&(t.value=n)}createStepper(t=1,e=null,s=null){const i=document.createElement("input");return i.setAttribute("type","number"),i.setAttribute("step",t),i.style.cssText="width: 60px","number"==typeof e&&i.setAttribute("min",e),"number"==typeof s&&i.setAttribute("max",s),i}}class _ extends p{constructor(t={},e=1,s=1){super({size:[e,s,0],...t}),this.name="rect"}update(){this.path=a.Rect(this.props.size.x,this.props.size.y,this.props.color,this.props.stroke)}}class x extends _{constructor(t={}){super({size:[1,1,1],...t}),this.props.extruded=!0,this.name="cube"}height(t){return this.props.size.z=t,this.update(),this}}class f extends p{constructor(t={},e=1,s=20){super(t),this.props={size:[e,e],segments:s,...this.props},this.name="circle"}size(){const t=e.get(...arguments);return this._setPoint("size",t.replace({x:t.x,y:t.x}))}radius(t){this.size(t,t)}segments(t){return this._setProp("segments",t)}update(){this.path=a.Circle(this.props.size.x,this.props.segments,this.props.color,this.props.stroke)}}class y extends f{constructor(t={},e=1,s=1,i=20){super({size:[e,e,s],...t},e,i),this.props.extruded=!0,this.name="cylinder"}height(t){return this.props.size.z=t,this.update(),this}}class z extends p{constructor(t={},e=1,s=1,i=1){super({size:[e,s,i],...t}),this.name="diamond"}height(t){return this.props.size.z=t,this.update(),this}update(){const{points:t}=a.Rect(this.props.size.x,this.props.size.y).translate({z:this.props.size.z/2}),{size:s,color:i,stroke:n}=this.props,r=e.get(s.x/2,s.y/2,this.props.size.z),o=e.get(s.x/2,s.y/2,0);this.clearPaths();for(let e,s,h=0;h<t.length;h++)e=t[h],s=h===t.length-1?t[0]:t[h+1],this.add(new a([e,s,r],i,n)),this.add(new a([e,s,o],i,n).reverse())}}class C extends p{constructor(t={}){super({size:[1,1,1],...t}),this.name="pyramid"}height(t){return this.props.size.z=t,this.update(),this}update(){const{size:t,color:s,stroke:i}=this.props,n=a.Rect(t.x,t.y,s,i),{points:r}=n,o=e.get(t.x/2,t.y/2,t.z);this.clearPaths(),this.add(n.reverse());for(let t,e,n=0;n<r.length;n++)t=r[n],e=n===r.length-1?r[0]:r[n+1],this.add(new a([t,e,o],s,i))}}class b extends p{static FACE__NN=180;static FACE__EE=-90;static FACE__SS=0;static FACE__WW=90;constructor(t){super({size:[1,1,1],...t}),this.props={direction:b.FACE__SS,...this.props},this.props.rotation=this.props.rotation.sum(0,0,this.props.direction),this.name="ramp"}update(){this.clearPaths();const{size:t,color:s,stroke:i}=this.props;this.add(a.Rect(t.x,t.y,s,i)),this.add(new a([e.get(0,0,0),e.get(t.x,0,0),e.get(t.x,0,t.z),e.get(0,0,t.z)],s,i)),this.add(new a([e.get(0,0,0),e.get(0,t.y,0),e.get(0,0,t.z)],s,i).reverse()),this.add(new a([e.get(t.x,0,0),e.get(t.x,t.y,0),e.get(t.x,0,t.z)],s,i)),this.add(new a([e.get(0,t.y,0),e.get(t.x,t.y,0),e.get(t.x,0,t.z),e.get(0,0,t.z)],s,i).reverse())}}class T extends p{static FACE__NN={size:e.get(0,1),pos:e.get(0,1,1)};static FACE__EE={size:e.get(1,0),pos:e.get(0,0,1)};static FACE__SS={size:e.get(0,1),pos:e.get(0,0,1)};static FACE__WW={size:e.get(1,0),pos:e.get(1,0,1)};static FACE__NW={size:e.get(1,1),pos:e.get(1,1,1)};static FACE__SW={size:e.get(1,1),pos:e.get(1,0,1)};static FACE__NE={size:e.get(1,1),pos:e.get(0,1,1)};static FACE__SE={size:e.get(1,1),pos:e.get(0,0,1)};constructor(t){super({size:[1,1,1],...t}),this.props={steps:10,direction:T.FACE__EE,...this.props},this.name="stairs"}update(){this.clearPaths();const{size:t,position:e,direction:s,steps:i,color:n,stroke:r}=this.props,o=t.mult(1/i);this.add(a.Rect(t.x,t.y,n,r));for(let e=0;e<i;e++){const i=t.sub(s.size.mult(o.mult(e))).round,h=s.pos.mult(o.mult(e)).round,p=a.Rect(i.x,i.y,n,r).translate(h);this.add([p,...a.extrude(p,o.z)])}}}class E extends _{constructor(t={}){super({size:[1,1,1],...t}),this.props.extruded=!0,this.name="lego"}height(t){return this.props.size.z=t,this.update(),this}update(){this.clearPaths(),super.update();const t=a.Circle(.6,20,this.props.color,this.props.stroke);for(let e=0,s=Math.floor(this.props.size.x);e<s;e++)for(let s=0,i=Math.floor(this.props.size.y);s<i;s++)this.add(a.extrude(t.translate(.2+e,.2+s,this.props.size.z),.2))}}class I extends h{constructor(t){super({size:[1,1,1],...t}),this.name="legobrick"}update(){super.update(),this._children=[];for(let t=0,e=Math.floor(this.props.size.x);t<e;t++)for(let e=0,s=Math.floor(this.props.size.y);e<s;e++)this.add(new E({position:[t,e],color:13369344}))}}class S extends m{constructor(){super();const t=[["Cube",x],["Cylinder",y],["Pyramid",C],["Diamond",z],["Ramp",b],["Stairs",T],["Lego",E],["LegoBrick",I]],e=this.createSelect(t.map((t=>t[0])));this.element.appendChild(e);const s=this.createButton("Add shape");s.addEventListener("click",(s=>{const i=t[e.value][1];this.onAdd(s,{instance:new i({color:13421772})})})),this.element.appendChild(s)}onAdd(t){}}class w extends m{constructor(t,e=.1,s=null,i=null){super(),this.prop=t;const n=document.createElement("span");n.textContent=t,this.point_x=this.createStepper(e,s,i),this.point_x.addEventListener("change",(()=>this.onChange())),this.point_y=this.createStepper(e,s,i),this.point_y.addEventListener("change",(()=>this.onChange())),this.point_z=this.createStepper(e,s,i),this.point_z.addEventListener("change",(()=>this.onChange())),this.element.appendChild(n),this.element.appendChild(this.point_x),this.element.appendChild(this.point_y),this.element.appendChild(this.point_z)}get value(){return[Number(this.point_x.value),Number(this.point_y.value),Number(this.point_z.value)]}update(t,e,s){this.point_x.value=t,this.point_y.value=e,this.point_z.value=s}}class P extends m{constructor(t){super(),this.shapes=t,this.currentShape=null,this.selectCurrentShape=this.createSelect([]),this.selectCurrentShape.addEventListener("change",(()=>{this.updateCurrentShape()})),this.color=new v,this.color.onChange=this.updateColor.bind(this),this.size=new w("size",.1,.1),this.size.onChange=this.updateSize.bind(this),this.position=new w("position",.1),this.position.onChange=this.updatePosition.bind(this),this.rotation=new w("rotation",10,0,360),this.rotation.onChange=this.updateRotation.bind(this),this.element.appendChild(this.selectCurrentShape),this.element.appendChild(this.color.element),this.element.appendChild(this.size.element),this.element.appendChild(this.position.element),this.element.appendChild(this.rotation.element)}onEdit(){}updateShapeList(t){this.updateSelect(this.selectCurrentShape,t),this.currentShape||(this.currentShape=this.shapes[0]),this.updateCurrentShape()}updateCurrentShape(){this.currentShape=this.shapes[this.selectCurrentShape.value],this.updateKnobs()}updateKnobs(){this.updateColorKnobs(),this.updateSizeKnobs(),this.updatePositionKnobs(),this.updateRotationKnobs()}updateColor(){this.currentShape?.color(this.color.value),this.onEdit()}updateColorKnobs(){const{color:t}=this.currentShape?.props||{};this.color.update(t)}updateSize(){this.currentShape?.size(this.size.value),this.updateSizeKnobs(),this.onEdit()}updateSizeKnobs(){const{x:t,y:e,z:s}=this.currentShape?.props.size||{};this.size.update(t,e,s)}updatePosition(){this.currentShape?.position(this.position.value),this.onEdit()}updatePositionKnobs(){const{x:t,y:e,z:s}=this.currentShape?.props.position||{};this.position.update(t,e,s)}updateRotation(){this.currentShape?.rotation(this.rotation.value),this.onEdit()}updateRotationKnobs(){const{x:t,y:e,z:s}=this.currentShape?.props.rotation||{};this.rotation.update(t,e,s)}}class v extends m{constructor(){super();const e=document.createElement("span");e.textContent="color",this.color=this.createTextField("text"),this.color.style.cssText="width: 80px",this.color.addEventListener("change",(()=>this.onChange?.()));const s=this.createButton("random");s.addEventListener("click",(()=>{this.color.value=t.random().string,this.onChange()})),this.element.appendChild(e),this.element.appendChild(this.color),this.element.appendChild(s)}get value(){return parseInt(Number("0x"+this.color.value.substr(1)))}update(t){this.color.value=t.string}}class A extends m{constructor(t){super(),this.element.style.cssText="flex: 1 1 50%",this.shapes=[],this.layer=t;const e=new P(this.shapes);e.onEdit=()=>this.layer.stage.render();const s=new S;s.onAdd=(t,{instance:s})=>{s.name=`${s.name||"shape"}_${this.shapes.length.toString()}`,this.shapes.push(s),this.layer.add(s),this.layer.stage.render(),e.updateShapeList(this.shapes.map((t=>t.name)))},this.element.appendChild(s.element),this.element.appendChild(e.element)}}class N extends l{constructor(t){super({size:[1,1],...t}),this.props={physical:!1,...this.props},this._frames=[],this._current=-1,this.UNIT=1}onAdd(){if(this.layer){const t=this.layer.UNIT/this.UNIT;this.props.scale=e.get(t,t);const s=this.layer.stage.imageCache[this.props.imagePath];s&&(this.image=s,this.updateImageSize(s),this.reposition())}this._frames.length&&this.renderFrame(0)}onLoad(){this.reposition()}reposition(){this._loaded&&(this.props.destinationPosition=this.props.destinationPosition.sum([-this.destination.size.x/2,-this.destination.size.y]))}addFrames(t){t.forEach((t=>{this.addFrame(t.position,t.size,t.offset)}))}addFrame(t,e,s){this._frames.push({size:e,position:t,offset:s})}renderFrame(t){this._current=t;const{size:s,position:i,offset:n}=this._frames[t],r=s&&s!==this.props.sourceSize,o=i&&i!==this.props.sourcePosition,h=n&&n!==this.props.destinationPosition;r&&(this.props.sourceSize=e.get(s)),r&&(this.props.destinationSize=e.get(s).mult(this.props.scale)),o&&(this.props.sourcePosition=e.get(i)),h&&(this.props.destinationPosition=e.get(n).mult(this.props.scale)),(h||r)&&this.reposition()}position(){const t=e.get(this.props.position);return super.position(...arguments),this.props.physical&&(this._setTile(t,0),this._setTile(this.props.position,1)),this}_setTile(t,e){const s=this.layer._gridpath;if(s)for(let i,n,r=0;r<this.props.size.y;r++)for(n=0;n<this.props.size.x;n++)i=this.layer.getTile(t.sum(n,r)),e?s.setTile(i.x,i.y):s.freeTile(i.x,i.y)}}class R extends N{constructor(t){super({physical:!0,imagePath:"img/trees.png",...t}),this.UNIT=40,this.addFrame([80,115],[110,120],[20,20]),this.addFrame([210,75],[86,160],[10,12]),this.addFrame([292,150],[106,90],[4,36]),this.addFrame([396,106],[124,128],[0,15]),this.addFrame([66,250],[114,155],[0,15]),this.addFrame([180,250],[140,155],[0,15]),this.addFrame([320,322],[80,84],[0,22]),this.addFrame([402,266],[130,146],[0,40])}renderRandomTree(){const t=parseInt(Math.random()*this._frames.length);this.renderFrame(t),2===this._current&&this.size(e.get(2,1))}positionRandom(t,s){const i=e.get(parseInt(Math.random()*(s.x-t.x))+t.x,parseInt(Math.random()*(s.y-t.y))+t.y,parseInt(Math.random()*(s.z-t.z))+t.z);this.position(i)}}class F{constructor(){this.NW={stand:[],walk:[]},this.NN={stand:[],walk:[]},this.NE={stand:[],walk:[]},this.EE={stand:[],walk:[]},this.SE={stand:[],walk:[]},this.SS={stand:[],walk:[]},this.SW={stand:[],walk:[]},this.WW={stand:[],walk:[]}}setDefault({position:t,size:e,offset:s}){this._frameDefaults=new k({position:t,size:e,offset:s})}addFrame(t,e,s){this[t][e].push(new k(s,this._frameDefaults))}setFrames(t,e,s){s.forEach((s=>this.addFrame(t,e,s)))}setDirection(t,e){for(let s in e)this.setFrames(t,s,e[s])}}class k{constructor({position:t,size:e,offset:s},{position:i,size:n,offset:r}={}){this.position=t||i,this.size=e||n,this.offset=s||r}}class O extends N{constructor(t){super(t),this.props={fps:12,renderMiddleFrames:!1,...this.props},this.step((t=>{if(t&&this._frames.length&&this.layer){const e=t/1e3,s=Math.round(e*this.props.fps)%this._frames.length;(this.props.renderMiddleFrames||s!=this._current)&&(this._current=s,this.renderFrame(s))}}))}}class L extends O{static TILE__NN=e.get(0,-1);static TILE__EE=e.get(1,0);static TILE__SS=e.get(0,1);static TILE__WW=e.get(-1,0);static TILE__NW=L.TILE__NN.sum(L.TILE__WW);static TILE__NE=L.TILE__NN.sum(L.TILE__EE);static TILE__SW=L.TILE__SS.sum(L.TILE__WW);static TILE__SE=L.TILE__SS.sum(L.TILE__EE);static ACTION__STAND="stand";static ACTION__WALK="walk";static DIR__NW="NW";static DIR__NN="NN";static DIR__NE="NE";static DIR__EE="EE";static DIR__SE="SE";static DIR__SS="SS";static DIR__SW="SW";static DIR__WW="WW";static DIR__DEFAULT=L.DIR__EE;constructor(t){super(t),this.name="token",this.props={velocity:.1,...this.props},this.animation=new F,this._path=[],this.ALIVE=!1,this.ACTION=L.ACTION__STAND,this.DIR=L.DIR__DEFAULT,this.walk=this.walk.bind(this),this.stand=this.stand.bind(this)}get lastTile(){return this._path.length?this._path[this._path.length-1]:this.props.position}get actions(){return Object.keys(this.animation[L.DIR__DEFAULT])}get directions(){return Object.keys(this.animation).filter((t=>"_"!==t.substr(0,1)))}onAdd(){this.updateFrames(),super.onAdd()}renderFrame(t){super.renderFrame(t),this.ALIVE&&this.ACTION===L.ACTION__WALK&&(this._path.length?this.position(this._path.shift()):this._random?this.moveToRandom():this.stand())}_getFrames(t=this.DIR){if(this.animation[t]?.[this.ACTION]?.length)return this.animation[t][this.ACTION];const e=Array(3).join(t.substr(0,1));if(this.animation[e]?.[this.ACTION]?.length)return this.animation[e][this.ACTION];if(this.animation[L.DIR__DEFAULT]?.[this.ACTION]?.length)return this.animation[L.DIR__DEFAULT][this.ACTION];throw new Error(`NO ANIMATION DIR:${this.DIR} - ACTION:${this.ACTION}`)}update(){if(super.update(),this._path.length){const t=this._path[0].sub(this.props.position).round;let e=t.x>=0?"E":"W",s=t.y>=0?"S":"N";0===t.y&&(s=e),0===t.x&&(e=s);const i=`${s}${e}`;this.DIR!==i&&(this._frames=this._getFrames(i)),this.DIR=i}}updateFrames(){this._frames=this._getFrames()}walk(){this.ALIVE=!0,this.ACTION===L.ACTION__WALK&&0!==this._frames.length||(this.ACTION=L.ACTION__WALK,this._frames=this._getFrames())}stand(){this.ALIVE=!0,this.ACTION===L.ACTION__STAND&&0!==this._frames.length||(this.ACTION=L.ACTION__STAND,this._frames=this._getFrames())}moveToTarget(t){console.log("moveToTarget",t),this.layer._gridpath.isFree(t.x,t.y)?(this._path=this._getPath(t,this.props.position),this.walk()):console.log("BUSY!!")}moveToRandom(t=-10,s=10){this._random=!0,this.moveToTarget(e.get(parseInt(Math.random()*(s-t))+t,parseInt(Math.random()*(s-t))+t)),this.walk()}moveNorth(){this._addTarget(L.TILE__NN),this.walk()}moveEast(){this._addTarget(L.TILE__EE),this.walk()}moveSouth(){this._addTarget(L.TILE__SS),this.walk()}moveWest(){this._addTarget(L.TILE__WW),this.walk()}_addTarget(t){const e=this.lastTile.sum(t);this._path=this._path.concat(this._getPath(e,this.lastTile))}_getPath(t,e){const s=e,i=t,n=s.distance(i)/this.props.velocity,r=i.sub(s).mult(1/n),o=[];for(var h=1;h<n;h++)o.push(s.sum(r.mult(h)));return o.push(i),o}}class D extends L{constructor(t){super({fps:6,velocity:.04,imagePath:"img/boy.png",renderMiddleFrames:!0,...t}),this.UNIT=30,this.animation.setDefault({size:[55,110],offset:[0,12]}),this.animation.setDirection(L.DIR__NN,{stand:[{position:[326,537]}],walk:[{position:[326,536]},{position:[262,536]},{position:[326,536]},{position:[390,536]}]}),this.animation.setDirection(L.DIR__EE,{stand:[{position:[100,280]}],walk:[{position:[100,280]},{position:[36,280]},{position:[100,280]},{position:[162,280]}]}),this.animation.setDirection(L.DIR__SS,{stand:[{position:[100,152]}],walk:[{position:[100,152]},{position:[36,152]},{position:[100,152]},{position:[162,152]}]}),this.animation.setDirection(L.DIR__WW,{stand:[{position:[100,536]}],walk:[{position:[100,536]},{position:[36,536]},{position:[100,536]},{position:[162,536]}]})}}class M extends m{constructor(){super();const t=[["Tree",R],["Boy",D]],e=this.createSelect(t.map((t=>t[0])));this.element.appendChild(e);const s=this.createButton("Add sprite");s.addEventListener("click",(s=>{const i=t[e.value][1];this.onAdd(s,{instance:new i({})})})),this.element.appendChild(s)}onAdd(t){}}class W extends m{constructor(t){super(),this.sprites=t,this.currentSprite=null,this.selectCurrentSprite=this.createSelect([]),this.selectCurrentSprite.addEventListener("change",(()=>{this.updateCurrentSprite()})),this.animation=new j,this.animation.onChange=this.updateAnimation.bind(this),this.frames=new K("frame"),this.frames.onChange=this.updateFrames.bind(this),this.position=new w("position",1),this.position.onChange=this.updatePosition.bind(this),this.element.appendChild(this.selectCurrentSprite),this.element.appendChild(this.animation.element),this.element.appendChild(this.frames.element),this.element.appendChild(this.position.element)}onEdit(){}updateSpriteList(t){this.updateSelect(this.selectCurrentSprite,t),this.currentSprite||(this.currentSprite=this.sprites[0]),this.updateCurrentSprite()}updateCurrentSprite(){this.currentSprite=this.sprites[this.selectCurrentSprite.value],this.updateKnobs()}updateKnobs(){this.updateFramesKnobs(),this.updatePositionKnobs(),this.updateAnimationKnobs()}updateAnimation(){if(this.currentSprite instanceof L){const{actions:t,directions:e}=this.currentSprite;this.currentSprite.ACTION=t[this.animation.value.action],this.currentSprite.DIR=e[this.animation.value.direction],this.currentSprite.updateFrames(),this.updateFramesKnobs(),this.updateFrames()}}updateAnimationKnobs(){this.animation.update(this.currentSprite)}updateFrames(){this.currentSprite?.renderFrame(this.frames.value),this.onEdit()}updateFramesKnobs(){this.frames.update({value:this.currentSprite._current,max:this.currentSprite._frames.length-1})}updatePosition(){this.currentSprite?.position(this.position.value),this.onEdit()}updatePositionKnobs(){const{x:t,y:e,z:s}=this.currentSprite.props.position;this.position.update(t,e,s)}}class K extends m{constructor(t,e=0,s=0,i=1){super(),this.prop=t;const n=document.createElement("span");n.textContent=t,this.output=document.createElement("span"),this.range=this.createRange(e,s,i),this.range.addEventListener("change",(()=>{this.output.textContent=this.range.value,this.onChange()})),this.element.appendChild(n),this.element.appendChild(this.range),this.element.appendChild(this.output)}get value(){return Number(this.range.value)}update({min:t,max:e,step:s,value:i}){this.updateRange(this.range,{min:t,max:e,step:s,value:i}),this.output.textContent=this.range.value}}class j extends m{constructor(){super();const t=document.createElement("span");t.textContent="animation",this.action=this.createSelect([]),this.action.addEventListener("change",(()=>{this.onChange()})),this.direction=this.createSelect([]),this.direction.addEventListener("change",(()=>{this.onChange()})),this.element.appendChild(t),this.element.appendChild(this.action),this.element.appendChild(this.direction)}get value(){return{action:Number(this.action.value),direction:Number(this.direction.value)}}update(t){if(t instanceof L){const{animation:e,actions:s,directions:i,ACTION:n,DIR:r}=t;this.updateSelect(this.action,e?s:[],s.indexOf(n)),this.updateSelect(this.direction,e?i:[],i.indexOf(r))}else this.updateSelect(this.action,[]),this.updateSelect(this.direction,[])}}class G extends m{constructor(t){super(),this.element.style.cssText="flex: 1 1 50%",this.sprites=[],this.layer=t;const e=new W(this.sprites);e.onEdit=()=>this.layer.stage.render();const s=new M;s.onAdd=(t,{instance:s})=>{s.name=`${s.name||"sprite"}_${this.sprites.length.toString()}`,this.sprites.push(s),this.layer.add(s),this.layer.stage.render(),e.updateSpriteList(this.sprites.map((t=>t.name)))},this.element.appendChild(s.element),this.element.appendChild(e.element)}}class B extends m{constructor(t){super(),this.element.style.cssText="flex: 1 1 100%",this.stage=t;const e=document.createElement("span");e.textContent="live",this.player=document.createElement("input"),this.player.setAttribute("type","checkbox"),this.player.addEventListener("change",(()=>{this.player.checked?this.stage.start():this.stage.stop()})),this.element.appendChild(e),this.element.appendChild(this.player)}}class H extends m{constructor(){super("label");const t=document.createElement("input");t.setAttribute("type","checkbox"),t.addEventListener("change",(t=>this.onChange(t.target.checked)));const e=document.createElement("span");e.style.cssText="margin: 0 4px; font-size: 14px;",e.textContent="toggle UI",this.element.appendChild(t),this.element.appendChild(e)}}const U=new g(g.ORIGIN__CENTER,g.TYPE__ISO,70);U.add([new class extends p{constructor(t,s=10066329){super();const i=-t,n=t;this.name="grid";for(let t=i;t<=n;t++)this.add(new a([e.get(t,i,0),e.get(t,n,0)],null,s));for(let t=i;t<=n;t++)this.add(new a([e.get(i,t,0),e.get(n,t,0)],null,s))}}(10),new class extends p{constructor(t){super(),this.name="axis",this.add([new a([e.get(-t,0,0),e.get(t,0,0)],null,255),new a([e.get(0,-t,0),e.get(0,t,0)],null,65280),new a([e.get(0,0,-t),e.get(0,0,t)],null,16711680)])}}(20)]);const Y=new g(g.ORIGIN__CENTER,g.TYPE__ISO,70);Y.addGridPath();const $=new g(g.ORIGIN__TOP_LEFT,g.TYPE__2D,1),q=new i({color:0,position:[0,0,0],text:"",align:"left",baseline:"top"});$.add([q]);const V=new u;V.preloadImage("img/boy.png"),V.preloadImage("img/trees.png"),V.add([U,Y,$]),V.showFPS((t=>q.text(`fps: ${t}`))),V.render();const X=new class extends m{constructor(t){super(),this.element.style.cssText="position: fixed; width: 100%; display: flex; flex-wrap: wrap; background-color: #dededede; padding: 8px; box-sizing: border-box; transition: bottom ease-in-out 200ms;",this.world=t;const e=new H;e.element.style.cssText="position: absolute; top: -30px;",e.onChange=t=>this.element.style.bottom=(t?0:-this.element.clientHeight)+"px",this.element.appendChild(e.element),new B(this.world.stage);const s=new A(this.world),i=new G(this.world);this.element.appendChild(s.element),this.element.appendChild(i.element)}init(){this.element.style.bottom=-this.element.clientHeight+"px"}}(Y);document.body.appendChild(X.element),X.init();
//# sourceMappingURL=main.js.map
